# ============================================================
# SCRIPT DE VISUALIZACIÓN PARA KALMAN + RTS SMOOTHER
# ============================================================

# 1. Configuración de la Ventana
set terminal wxt size 1200,800 enhanced font 'Segoe UI,10' persist
# Si prefieres guardar la imagen directamente, descomenta la siguiente línea:
# set terminal pngcairo size 1200,800 enhanced font 'Verdana,10'; set output 'resultado_kalman.png'

# 2. Estilo General
set grid xtics ytics ls 100 lc rgb '#dddddd' lw 1
set key right top box opaque
set datafile separator whitespace  # Fortran escribe con espacios

# 3. Configuración Multiplot (2 paneles)
set multiplot layout 2,1 title "Resultado: Filtro Kalman + RTS Smoother" font ",14"

# --- PANEL SUPERIOR: SEÑAL ---
set title "Comparativa: Medición Ruidosa vs Estimación Suavizada"
set ylabel "Amplitud (Logarítmica)"
set format x ""      # Ocultamos números X para no repetir
set bmargin 1        # Pegamos las gráficas

# Col 1: Tiempo | Col 2: Medición (z) | Col 3: Estimación (x)
plot "kalman_output.txt" using 1:2 with points pt 7 ps 0.5 lc rgb "#AAAAAA" title "Medición (Sensor)", \
     "kalman_output.txt" using 1:3 with lines lw 2 lc rgb "#D9534F" title "Estimación Suavizada"

# --- PANEL INFERIOR: RESIDUOS ---
set title "Residuos (Innovación Post-Proceso)"
set xlabel "Tiempo (s)"
set ylabel "Error (Medición - Est.)"
set format x "%g"    # Restauramos números X
set tmargin 1        # Pegamos las gráficas
set bmargin 3

# Calculamos la diferencia en caliente ($2-$3)
# Si la línea azul oscila alrededor de 0, el filtro funciona bien.
plot "kalman_output.txt" using 1:($2-$3) with lines lw 1 lc rgb "#5BC0DE" title "Ruido Residual"

unset multiplot